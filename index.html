<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Manager Pro</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üòé</text></svg>">
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    
    <style>
        :root {
            --primary: #24292f;
            --accent: #0969da;
            --danger: #cf222e;
            --bg: #f6f8fa;
            --border: #d0d7de;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: #1f2328;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº„Éá„Ç∂„Ç§„É≥„ÅÆÁ∂≠ÊåÅ */
        header {
            background-color: var(--primary);
            color: white;
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
            display: none; /* „É≠„Ç∞„Ç§„É≥„Åæ„ÅßÈùûË°®Á§∫ */
        }

        /* „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Çª„ÇØ„Ç∑„Éß„É≥ */
        .upload-section {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        /* „Ç∞„É™„ÉÉ„Éâ„Å®„Ç´„Éº„Éâ„Éá„Ç∂„Ç§„É≥„ÅÆÁ∂≠ÊåÅ */
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }

        .asset-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .asset-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(140,149,159,0.2);
        }

        .preview-container {
            width: 100%;
            height: 240px;
            background-color: #eee;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .asset-info {
            padding: 16px;
        }

        .asset-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 12px;
            word-break: break-all;
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid var(--border);
            background: white;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
        }

        .btn-primary:hover { opacity: 0.9; }

        .btn-danger {
            color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #ffebe9;
            border-color: var(--danger);
        }

        /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ */
        .login-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            width: 320px;
        }

        input[type="password"], input[type="file"] {
            width: 100%;
            padding: 8px;
            margin: 16px 0;
            border: 1px solid var(--border);
            border-radius: 6px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<div id="login-screen" class="login-overlay">
    <div class="login-box">
        <h2 style="margin:0 0 20px 0;">üòé Authenticate</h2>
        <input type="password" id="pass-input" placeholder="Enter Passcode">
        <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; padding:12px;">Login</button>
    </div>
</div>

<header>
    <div style="font-size: 20px; font-weight: 700;">üòé Asset Manager Pro</div>
    <button onclick="location.reload()" class="btn" style="width:auto;">Reload</button>
</header>

<div class="container" id="app-content">
    <div class="upload-section">
        <div style="flex-grow:1">
            <label style="font-size:12px; font-weight:bold;">GitHub„Å∏Áõ¥Êé•„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ:</label>
            <input type="file" id="gh-upload-file" style="margin: 8px 0 0 0;">
        </div>
        <button onclick="handleGithubUpload()" id="up-btn" class="btn btn-primary" style="height:40px; margin-top:18px; padding:0 24px;">„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆüË°å</button>
    </div>

    <h3 style="margin: 0 0 16px 0; border-bottom: 2px solid var(--primary); padding-bottom: 8px;">Asset List</h3>
    <div class="asset-grid" id="main-grid"></div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwTJOiXCz6az0e-CV4_oJvtNu9Tt4-QpUbHsc2jyWQvQaDovYkno6qpkFoD-lwmp1hvcQ/exec";
    const GH_USER = "nplus-hub";
    const GH_REPO = "my-assets";
    const GH_RAW_BASE = `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/main/`;

    // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
    async function attemptLogin() {
        const pass = document.getElementById('pass-input').value;
        const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "auth", pass: pass }) });
        const result = await res.json();
        
        if (result.success) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            refreshGallery();
        } else {
            alert("Passcode incorrect.");
        }
    }

    // ÂÖ®Ë°®Á§∫„ÅÆ„É™„Éï„É¨„ÉÉ„Ç∑„É•ÔºàGitHub + DriveÔºâ
    async function refreshGallery() {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = "<p>Loading assets...</p>";

        try {
            // 1. GitHub„Éï„Ç°„Ç§„É´„ÅÆÂèñÂæó
            const ghRes = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/`);
            const ghFiles = await ghRes.json();
            
            // 2. Drive„Éï„Ç°„Ç§„É´„ÅÆÂèñÂæóÔºàGASÁµåÁî±Ôºâ
            const drRes = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "list_drive" }) });
            const drFiles = await drRes.json();

            grid.innerHTML = "";

            // GitHubË≥áÁî£„ÅÆ„Ç´„Éº„ÉâÁîüÊàê
            ghFiles.filter(f => f.name.endsWith('.glb')).forEach(file => {
                const url = GH_RAW_BASE + file.name;
                createCard(grid, file.name, url, true);
            });

            // DriveË≥áÁî£„ÅÆ„Ç´„Éº„ÉâÁîüÊàê
            drFiles.forEach(file => {
                createCard(grid, file.name, file.id, false);
            });

        } catch (e) {
            grid.innerHTML = "<p>Error loading data.</p>";
        }
    }

    function createCard(container, name, pathOrId, isGithub) {
        const card = document.createElement('div');
        card.className = 'asset-card';
        
        // „Éó„É¨„Éì„É•„ÉºË°®Á§∫ÔºàGitHub„ÅØË°®Á§∫„ÄÅDrive„ÅØ„Éó„É¨„Éì„É•„Éº‰∏çÂèØÔºâ
        const previewHtml = isGithub 
            ? `<model-viewer src="${pathOrId}" auto-rotate camera-controls shadow-intensity="1"></model-viewer>`
            : `<div style="text-align:center; color:#888; font-size:12px;">Drive Asset<br>(Preview Unavailable)</div>`;

        card.innerHTML = `
            <div class="preview-container">${previewHtml}</div>
            <div class="asset-info">
                <div class="asset-name">${name}</div>
                <div class="button-group">
                    ${isGithub 
                        ? `<button class="btn" onclick="copyToClipboard('${pathOrId}')">URL„Ç≥„Éî„Éº</button>` 
                        : `<button class="btn btn-danger" onclick="handleDelete('${pathOrId}')">Drive„Åã„ÇâÂâäÈô§</button>`
                    }
                </div>
            </div>
        `;
        container.appendChild(card);
    }

    async function handleGithubUpload() {
        const fileInput = document.getElementById('gh-upload-file');
        if (fileInput.files.length === 0) return alert("„Éï„Ç°„Ç§„É´„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ");
        
        const file = fileInput.files[0];
        const btn = document.getElementById('up-btn');
        btn.innerText = "Âá¶ÁêÜ‰∏≠..."; btn.disabled = true;

        const reader = new FileReader();
        reader.onload = async () => {
            const base64 = reader.result.split(',')[1];
            const res = await fetch(GAS_URL, { 
                method: "POST", 
                body: JSON.stringify({ type: "github_upload", filename: file.name, base64: base64 }) 
            });
            const result = await res.json();
            if (result.content) {
                alert("GitHub„Å∏„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü");
                refreshGallery();
            } else {
                alert("„Ç®„É©„Éº: " + (result.message || "‰∏çÊòé„Å™„Ç®„É©„Éº"));
            }
            btn.innerText = "„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆüË°å"; btn.disabled = false;
        };
        reader.readAsDataURL(file);
    }

    async function handleDelete(id) {
        if (!confirm("Google Drive„Åã„Çâ„Åì„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
        const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ type: "delete", id: id }) });
        const result = await res.json();
        if (result.status === "success") {
            alert("ÂâäÈô§„Åó„Åæ„Åó„Åü");
            refreshGallery();
        }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => alert("URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü"));
    }
</script>

</body>
</html>
